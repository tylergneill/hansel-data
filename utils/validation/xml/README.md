# HANSEL XML Validation Workflow

This directory captures the full validation toolchain for HANSEL’s TEI-XML project editions. It keeps the assets used by the command-line pipeline, the Oxygen IDE workflow, and a small utility that compares their outputs.

- `schemas/` — SARIT-derived validation assets: the `.odd`, compiled `.rng`, `.isosch`, and a local copy of the ISO Schematron skeleton XSLTs used to produce a validator stylesheet.
- `cli/` — artefacts generated by the Makefile-driven CLI flow (SVRL reports plus raw Jing logs).
- `oxygen_comparison/` — helper scripts and CSV outputs for munging Oxygen logs, aggregating CLI results, and reconciling the two sets.
- `Makefile` — runs RELAX NG (Jing) and Schematron (Saxon) for every XML file under `texts/project_editions/xml`, and exposes a `compare` target that orchestrates the downstream CSV workflows.

The repository no longer carries sample XML input; the CLI defaults to the project’s curated editions. You can override targets with `make XML_DIR=/path/to/xml`.

## Prerequisites

Homebrew installs provide the required engines:

```sh
brew install jing-trang
brew install saxon
```

The Makefile expects the `jing` and `saxon` executables to be on `PATH`. If you prefer Saxon-HE via Java, set `SAXON="java -jar /path/to/saxon-he.jar"`.

## CLI Validation Pipeline

1. Ensure schemas are present. The repo includes them, but you can refresh the ISO skeleton transforms with `make fetch-skeleton`.
2. Run the validation pass:
   ```sh
   make
   ```
   SVRL reports land in `cli/reports/`, and raw Jing output plus summaries go to `cli/build/`.
3. (Optional) Aggregate failures into a CSV for quick comparison:
   ```sh
   python oxygen_comparison/make_reports_to_csv.py
   ```
   The script emits `oxygen_comparison/makefile_fails.csv`. Running `make compare` later will invoke this automatically.

## Oxygen Workflow

The files in `oxygen_comparison/` let you keep a record of Oxygen XML Editor runs. After exporting logs from Oxygen, drop them into `oxygen_comparison/oxygen_logs.txt` and normalise them:

```sh
python oxygen_comparison/oxygen_logs_to_csv_blocks.py
```

This produces `oxygen_comparison/oxygen_fails.csv` with the same columns as the CLI CSV.

## Comparing Results

To check whether the GUI and CLI validations agree, either run the new Makefile target:

```sh
make compare
```

Place the exported Oxygen log as `oxygen_comparison/oxygen_logs.txt` beforehand.

or execute the comparison script directly:

```sh
python oxygen_comparison/compare_fail_csvs.py
```

The process writes `oxygen_comparison/only_makefile.csv`, `oxygen_comparison/only_oxygen.csv`, and `oxygen_comparison/shared_both.csv`, grouping by SVRL file, status, and message. Counts from each source are embedded so you can spot drift easily.

## Notes

- All output directories (`cli/build`, `cli/reports`, Oxygen CSVs, comparison CSVs) are derived artefacts and can be regenerated.
- `make clean` removes the generated reports/CSVs and recreates an empty `oxygen_comparison/oxygen_logs.txt` ready for the next run.
- Adjust the Makefile variables (`XML_DIR`, `RNG`, `SCH`, `OUT_DIR`, etc.) at runtime if you need to target alternative corpora or schema builds.
